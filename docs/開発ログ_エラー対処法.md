# VEXUM出退勤管理アプリ 開発ログ & エラー対処法

## 📋 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [開発の流れ（時系列）](#開発の流れ時系列)
3. [発生したエラーと解決方法](#発生したエラーと解決方法)
4. [ファイル構成](#ファイル構成)
5. [デプロイ手順](#デプロイ手順)
6. [GitHub & PWA対応](#github--pwa対応)
7. [今後の参考情報](#今後の参考情報)

---

## プロジェクト概要

**アプリ名**: VEXUM Attendance（出退勤管理アプリ）
**目的**: 研修生の出退勤打刻、課題完了報告、勤務時間集計
**技術スタック**:
- フロントエンド: HTML, CSS, JavaScript (PWA対応)
- バックエンド: Google Apps Script (GAS)
- データベース: Google Spreadsheet
- 通知: LINE Messaging API

**主要機能**:
- ✅ 出勤・退勤打刻
- ✅ 課題完了報告（480分以上で合格/不合格判定）
- ✅ 週間・月間勤務時間集計
- ✅ LINE通知（出勤・退勤・課題完了）
- ✅ VEXUMブランディング適用
- ✅ PWA対応（アプリとしてインストール可能）

---

## 開発の流れ（時系列）

### 1️⃣ 初期セットアップ
1. `index.html` と `main.js` を作成
2. 基本的な出退勤打刻機能を実装

### 2️⃣ デザイン改善
- モダンなグラデーションデザインに変更
- Tailwind風のCSS変数を使用
- レスポンシブ対応

### 3️⃣ GAS統合
- `Code.gs` でバックエンドAPI作成
- Google Spreadsheetと連携
- LINE通知機能追加

### 4️⃣ 🚨 **エラー発生期（最重要）**
- 出勤ボタンを押してもアプリ上では未出勤と表示される
- 退勤時に `clockInTime.split is not a function` エラー
- デプロイバージョンの不一致

### 5️⃣ エラー修正
- 日付・時刻のデータ型変換処理を追加
- すべての関数に型チェックを実装
- デプロイの確認手順を確立

### 6️⃣ VEXUMブランディング
- ロゴ、カラー（#0ea5e9）、スローガンを追加
- 課題完了機能のURL入力削除

### 7️⃣ GitHub & PWA対応
- Gitリポジトリ初期化
- manifest.json, service-worker.js 作成
- GitHub Pagesでホスティング準備

---

## 発生したエラーと解決方法

### ❌ エラー1: 出勤ボタンを押しても「未出勤」と表示される

#### 症状
- スプレッドシートには正しく記録されている
- フロントエンド（アプリ画面）では「未出勤」のまま
- 出勤時刻、日付も正しく記録されている

#### 原因
**日付の型不一致**

Google Spreadsheetから取得した日付は `Date` オブジェクト型だが、コード内では文字列 `"2025-10-28"` と比較していた。

```javascript
// ❌ 問題のあったコード
const todayStr = Utilities.formatDate(new Date(), TIMEZONE, 'yyyy-MM-dd');
if (date === todayStr) {  // dateはDateオブジェクト、todayStrは文字列
  // 常にfalseになってしまう
}
```

#### 解決方法
**型チェックを追加して、Dateオブジェクトを文字列に変換**

```javascript
// ✅ 修正後のコード
const todayStr = Utilities.formatDate(new Date(), TIMEZONE, 'yyyy-MM-dd');

// Dateオブジェクトの場合は文字列に変換
const dateStr = (date instanceof Date)
  ? Utilities.formatDate(date, TIMEZONE, 'yyyy-MM-dd')
  : String(date);

if (dateStr === todayStr) {
  // 正しく比較できる
}
```

#### 適用箇所
- `getStatus()` 関数
- `findOpenRowForUser()` 関数
- `getWeeklyMinutes()` 関数
- `getMonthlyMinutes()` 関数

---

### ❌ エラー2: `TypeError: clockInTime.split is not a function`

#### 症状
- 退勤ボタンをクリックすると発生
- エラーメッセージ: `TypeError: clockInTime.split is not a function`
- スプレッドシートには出勤時刻が記録されている

#### 原因
**時刻データの型不一致**

Google Spreadsheetで時刻セルを「時刻」形式にしていると、`getValues()` で取得した値が文字列 `"17:03"` ではなく、Dateオブジェクト `Sat Dec 30 1899 17:03:00 GMT+0900` になる。

```javascript
// ❌ 問題のあったコード
function calculateWorkingMinutes(clockInTime, clockOutTime) {
  const [inH, inM] = clockInTime.split(':').map(Number);
  // clockInTimeがDateオブジェクトの場合、splitメソッドが存在しない
}
```

#### 解決方法
**型チェックを追加して、Dateオブジェクトを "HH:mm" 文字列に変換**

```javascript
// ✅ 修正後のコード
function calculateWorkingMinutes(clockInTime, clockOutTime) {
  // 入力チェック
  if (!clockInTime) {
    throw new Error('clockInTime が空です');
  }

  // Dateオブジェクトの場合は "HH:mm" 形式に変換
  let inStr;
  if (clockInTime instanceof Date) {
    inStr = Utilities.formatDate(clockInTime, TIMEZONE, 'HH:mm');
  } else if (typeof clockInTime === 'object' && clockInTime.toString) {
    // オブジェクトの場合は一旦Dateに変換
    const d = new Date(clockInTime);
    inStr = Utilities.formatDate(d, TIMEZONE, 'HH:mm');
  } else {
    // 文字列の場合はそのまま使用
    inStr = String(clockInTime);
  }

  // clockOutTimeも同様に処理
  let outStr;
  if (!clockOutTime) {
    throw new Error('clockOutTime が空です');
  } else if (clockOutTime instanceof Date) {
    outStr = Utilities.formatDate(clockOutTime, TIMEZONE, 'HH:mm');
  } else if (typeof clockOutTime === 'object' && clockOutTime.toString) {
    const d = new Date(clockOutTime);
    outStr = Utilities.formatDate(d, TIMEZONE, 'HH:mm');
  } else {
    outStr = String(clockOutTime);
  }

  // 時刻を分割して計算
  const [inH, inM] = inStr.split(':').map(Number);
  const [outH, outM] = outStr.split(':').map(Number);

  let totalMinutes = (outH * 60 + outM) - (inH * 60 + inM);
  if (totalMinutes < 0) totalMinutes += 24 * 60;

  return totalMinutes;
}
```

#### 適用箇所
- `calculateWorkingMinutes()` 関数（最重要）
- `clockOut()` 関数内の時刻取得処理
- `getStatus()` 関数内の時刻表示処理
- `completeTask()` 関数
- 全ての時刻を扱う関数

#### 重要なポイント
Google Spreadsheetのセル書式設定によって、取得されるデータ型が変わる：
- 📅 「日付」形式 → `Date` オブジェクト
- 🕐 「時刻」形式 → `Date` オブジェクト（1899年基準）
- 📝 「書式なしテキスト」形式 → 文字列

**対策**: 常に型チェックを行い、柔軟に対応する

---

### ❌ エラー3: デプロイバージョンの不一致

#### 症状
- ローカルで修正したコードがGASで動作しない
- エラーが修正されたはずなのに、同じエラーが発生する

#### 原因
**GASエディタに古いコード（420行）がデプロイされていた**

最新のCode.gs（530行、エラー修正済み）がGASエディタに反映されていなかった。

#### 解決方法
1. ローカルの `Code.gs` を全選択してコピー
2. GASエディタで全て削除して貼り付け
3. **必ず新バージョンでデプロイ**

**デプロイ手順**:
```
1. GASエディタで「デプロイ」→「デプロイを管理」
2. 既存のデプロイの「編集（ペンアイコン）」をクリック
3. 「バージョン」→「新バージョン」を選択
4. 「デプロイ」ボタンをクリック
```

#### URLの確認
- デプロイ後もURLは変わらない
- `https://script.google.com/macros/s/AKfycbw.../exec` は固定
- バージョン管理は内部で行われる

---

### ❌ エラー4: IDの比較で一致しない

#### 症状
- user01で記録しているはずなのに、データが見つからない

#### 原因
**文字列の前後に空白文字が含まれていた**

スプレッドシートのセルに空白が含まれていると、`"user01"` と `"user01 "` は別物として扱われる。

#### 解決方法
**trim() で空白を除去してから比較**

```javascript
// ✅ 修正後のコード
const vidStr = String(vid).trim();
const idStr = String(id).trim();

if (vidStr === idStr) {
  // 正しく一致判定できる
}
```

#### 適用箇所
- 全てのID比較処理

---

## ファイル構成

```
attendance-app/
├── index.html              # メインHTML（PWA対応）
├── main.js                 # フロントエンドロジック
├── style.css               # VEXUMデザイン
├── manifest.json           # PWAマニフェスト
├── service-worker.js       # Service Worker（キャッシュ管理）
├── Code.gs                 # GASバックエンド（530行、エラー修正済み）
├── setup.gs                # 初期設定スクリプト
├── .gitignore              # Git除外設定
├── assets/
│   └── vexum-logo.png      # VEXUMロゴ
└── docs/
    ├── 出退勤打刻アプリ仕様書.md
    ├── デプロイ手順書.md
    └── 開発ログ_エラー対処法.md  # このファイル
```

---

## デプロイ手順

### 1. Google Spreadsheet準備

#### シート構成
- **研修生マスタ**: ID, 氏名
- **打刻記録**: 日付, 研修生ID, 氏名, 出勤時刻, 退勤時刻, 勤務時間
- **課題完了記録**: 完了日時, 研修生ID, 氏名, アプリURL, 合格/不合格

#### スプレッドシートID取得
URLの `/d/` と `/edit` の間の文字列
```
https://docs.google.com/spreadsheets/d/【ここがID】/edit
```

### 2. LINE Messaging API設定

1. LINE Developersコンソールにログイン
2. 新規チャネル作成（Messaging API）
3. **チャネルアクセストークン**をコピー
4. Webhookは無効でOK

#### グループID取得方法
```javascript
// 一時的にCode.gsに追加して実行
function getGroupId() {
  const token = 'YOUR_LINE_TOKEN';
  const url = 'https://api.line.me/v2/bot/groups';
  // または適当なメッセージをグループに送って、WebhookでIDを確認
}
```

### 3. Google Apps Script設定

#### 3.1 スクリプトプロパティ設定
```
プロジェクトの設定 → スクリプトプロパティ

SHEET_ID      : スプレッドシートID
LINE_TOKEN    : LINEチャネルアクセストークン
LINE_GROUP_ID : LINEグループID（例: C5a5b...）
APP_URL       : https://shared-ai-sudo.github.io/attendance-app（省略可）
```

#### 3.2 デプロイ手順
```
1. Code.gsの内容をGASエディタに貼り付け
2. 「デプロイ」→「新しいデプロイ」
3. 種類: ウェブアプリ
4. 次のユーザーとして実行: 自分
5. アクセスできるユーザー: 全員
6. 「デプロイ」をクリック
7. ウェブアプリURLをコピー
```

#### 3.3 main.jsにURL設定
```javascript
// main.js 11行目
const API_URL = 'https://script.google.com/macros/s/AKfycbw.../exec';
```

### 4. GitHub Pages公開

#### 4.1 リポジトリ作成
```bash
cd attendance-app
git init
git add .
git commit -m "Initial commit: VEXUM出退勤管理アプリ"
git branch -M main
git remote add origin https://github.com/shared-ai-sudo/attendance-app
git push -u origin main
```

#### 4.2 GitHub Pages有効化
```
1. GitHubリポジトリ → Settings
2. 左メニュー → Pages
3. Source: Deploy from a branch
4. Branch: main / (root)
5. Save
```

数分後、`https://shared-ai-sudo.github.io/attendance-app` で公開される

---

## GitHub & PWA対応

### PWAインストール方法

#### Android (Chrome)
1. https://shared-ai-sudo.github.io/attendance-app にアクセス
2. 画面下部「ホーム画面に追加」をタップ
3. インストール完了

#### iOS (Safari)
1. https://shared-ai-sudo.github.io/attendance-app にアクセス
2. 共有ボタン → 「ホーム画面に追加」
3. インストール完了

### Service Worker機能
- ✅ 静的リソースのキャッシュ（高速起動）
- ✅ オフラインでもUI表示可能
- ✅ GAS API呼び出しは常にオンライン
- ✅ 自動キャッシュ更新

---

## 今後の参考情報

### データ型関連の注意点

#### Google Spreadsheetのデータ取得
```javascript
// 常に型チェックを行う習慣を
const value = sheet.getRange(row, col).getValue();

// Dateオブジェクトの場合
if (value instanceof Date) {
  const formatted = Utilities.formatDate(value, 'Asia/Tokyo', 'yyyy-MM-dd');
}

// 数値の場合
if (typeof value === 'number') {
  const str = String(value);
}

// 文字列の場合
if (typeof value === 'string') {
  const trimmed = value.trim();
}
```

### デバッグ方法

#### GASのログ確認
```javascript
Logger.log('デバッグ: ' + JSON.stringify(data));
console.log('変数の値:', variable);  // Stackdriver Logging

// 実行ログで確認
// 実行 → ログを表示
```

#### フロントエンドのデバッグ
```javascript
// main.js で既に実装済み
console.log('📤 リクエスト送信:', requestBody);
console.log('📥 レスポンス内容:', result);
```

Chrome DevTools で確認:
- F12 → Console タブ
- Network タブでAPI通信確認

### コードのバージョン管理

#### ローカルとGASの同期
```
1. ローカルで修正
2. Code.gsをコピー
3. GASエディタに貼り付け
4. 必ず「新バージョン」でデプロイ
5. 動作確認
6. git commit & push
```

#### 行数でバージョン確認
- ローカル: `wc -l Code.gs` (Linux/Mac) または行数表示
- GAS: エディタ右下に行数表示

### CORS対策

#### Content-Type: text/plain を使用
```javascript
// プリフライトリクエスト（OPTIONS）を回避
fetch(API_URL, {
  method: 'POST',
  headers: {
    'Content-Type': 'text/plain'  // application/json ではない
  },
  body: JSON.stringify(data)
});
```

#### GAS側でCORS許可
```javascript
// doPost内で設定済み
return ContentService
  .createTextOutput(JSON.stringify(response))
  .setMimeType(ContentService.MimeType.JSON);
```

### エラーハンドリングのベストプラクティス

```javascript
// 必ず try-catch を使う
try {
  const result = someFunction();
  if (!result) {
    throw new Error('結果が取得できませんでした');
  }
  return result;
} catch (error) {
  console.error('❌ エラー:', error);
  Logger.log('エラー詳細: ' + error.stack);
  return { ok: false, message: error.message };
}
```

---

## まとめ

### 最重要ポイント

1. **Google Spreadsheetから取得したデータは型チェック必須**
   - 日付 → `Date` オブジェクト
   - 時刻 → `Date` オブジェクト（1899年基準）
   - 常に `instanceof Date` でチェック

2. **GASのデプロイは「新バージョン」で**
   - 古いコードがデプロイされていないか確認
   - 行数で簡易チェック可能

3. **文字列比較は trim() を忘れずに**
   - スプレッドシートの空白に注意

4. **デバッグログは多めに**
   - `console.log()` と `Logger.log()` を活用

### トラブルシューティング

| 症状 | 確認項目 | 解決方法 |
|------|----------|----------|
| ボタンを押しても反応しない | Consoleにエラーが出ていないか | DevTools → Console確認 |
| データが取得できない | スプレッドシートのシート名 | 厳密一致か確認 |
| IDが一致しない | 空白文字の有無 | trim() 追加 |
| 日付/時刻エラー | データ型 | instanceof Date でチェック |
| デプロイしても変わらない | バージョン | 「新バージョン」で再デプロイ |
| CORS エラー | Content-Type | text/plain を使用 |

---

**作成日**: 2025-10-28
**バージョン**: 1.0
**開発環境**: Windows, Google Apps Script, GitHub Pages
